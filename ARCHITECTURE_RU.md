# 🏗️ Klinika Pro PACS - Системная Архитектура

## 🎯 Обзор Архитектуры

Klinika Pro PACS следует архитектуре микросервисов с контейнеризованными компонентами, обеспечивающей масштабируемость, поддерживаемость и безопасность для рабочих процессов медицинских изображений.

---

## 🔄 Высокоуровневая Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                        ИНТЕРНЕТ                             │
└──────────────────────┬──────────────────────────────────────┘
                       │ HTTPS/SSL (Порт 443)
                       │ HTTP Редирект (Порт 80)
┌──────────────────────▼──────────────────────────────────────┐
│               NGINX REVERSE PROXY                           │
│         (SSL Терминация и Балансировка Нагрузки)           │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
└──┤ Заголовки   │ Правила     │   CORS      │ Стратегия   ├──┘
   │Безопасности │Маршрутизации│  Политика   │Кэширования  │
   └─────────────┴─────────────┴─────────────┴─────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
   ┌────▼───┐    ┌─────▼────┐    ┌────▼────────┐
   │ OHIF   │    │  Flask   │    │   Orthanc   │
   │Viewer  │    │  Auth    │    │   DICOM     │
   │        │    │ Service  │    │   Server    │
   │Порт 80 │    │Порт 5000 │    │ Порт 8042   │
   └────────┘    └──────────┘    └─────────────┘
                                        │
                                 ┌──────▼──────┐
                                 │ PostgreSQL  │
                                 │База Данных  │
                                 │ Порт 5432   │
                                 └─────────────┘
```

---

## 🧩 Компонентная Архитектура

### 1. **Фронтенд Слой**

```
┌──────────────────────────────────────────────────────────┐
│                    OHIF VIEWER                           │
├──────────────────────────────────────────────────────────┤
│  React Компоненты    │  Движок Медицинских Изображений  │
│  - Браузер Исследований │  - DICOM Рендеринг             │
│  - Менеджер Окон     │  - MPR Реконструкция              │
│  - Менеджер Инструментов │  - 3D Объемный Рендеринг     │
│  - UI Компоненты     │  - Обработка Изображений          │
├──────────────────────────────────────────────────────────┤
│                Пользовательские Расширения               │
│  - Система Врачебных Отчетов (customizations.js)        │
│  - Многоязычная Поддержка (5 языков)                    │
│  - Интерфейс Управления Аккаунтами                      │
│  - Функциональность Экспорта PDF                        │
│  - Ролевые UI Контролы                                  │
└──────────────────────────────────────────────────────────┘
```

### 2. **Слой Аутентификации**

```
┌──────────────────────────────────────────────────────────┐
│                 FLASK AUTH SERVICE                       │
├──────────────────────────────────────────────────────────┤
│  Аутентификация      │  Авторизация                      │
│  - Управление JWT    │  - Ролевой Контроль Доступа      │
│  - Обработка Сессий  │  - Валидация Разрешений          │
│  - Управление Польз. │  - Аудит Логирование             │
│  - Политика Паролей  │  - Интеграция Orthanc            │
├──────────────────────────────────────────────────────────┤
│                    Пользовательские Роли                 │
│  Admin: Полный Доступ │  Doctor: Отчеты+Просмотр        │
│  Operator: Загрузка+Просмотр │  Custom: Настраиваемый    │
└──────────────────────────────────────────────────────────┘
```

### 3. **DICOM Бэкенд Слой**

```
┌──────────────────────────────────────────────────────────┐
│                 ORTHANC DICOM SERVER                     │
├──────────────────────────────────────────────────────────┤
│  DICOM Ядро          │  DICOMweb API                     │
│  - C-STORE SCP       │  - QIDO-RS (Запрос)              │
│  - C-FIND SCP        │  - WADO-RS (Получение)           │
│  - C-MOVE SCP        │  - STOW-RS (Хранение)            │
│  - Классы Хранения   │  - REST Эндпоинты                │
├──────────────────────────────────────────────────────────┤
│  Плагины             │  Интеграция с Базой Данных       │
│  - Авторизация       │  - PostgreSQL Бэкенд             │
│  - DICOMweb         │  - Индексация Метаданных         │
│  - Сжатие           │  - Полнотекстовый Поиск          │
│  - Авто-маршрутизация │  - Оптимизация Производительности │
└──────────────────────────────────────────────────────────┘
```

### 4. **Слой Персистентности Данных**

```
┌──────────────────────────────────────────────────────────┐
│                 POSTGRESQL DATABASE                      │
├──────────────────────────────────────────────────────────┤
│  DICOM Метаданные    │  Управление Пользователями       │
│  - Таблица Studies   │  - Таблица Users                 │
│  - Таблица Series    │  - Таблица Sessions              │
│  - Таблица Instances │  - Таблица Audit Logs           │
│  - Таблица Patient   │  - Роли и Разрешения             │
├──────────────────────────────────────────────────────────┤
│  Хранение Файлов     │  Возможности Производительности  │
│  - DICOM Файлы       │  - Пулинг Соединений            │
│  - Сжатые Данные     │  - Оптимизация Запросов         │
│  - Стратегия Бэкапа  │  - Управление Индексами         │
│  - Монтирование Томов │  - ACID Соответствие            │
└──────────────────────────────────────────────────────────┘
```

---

## 🔄 Диаграммы Потоков Данных

### 1. **Поток Аутентификации Пользователя**

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ Браузер │    │  Nginx  │    │  Flask  │    │База Дан.│
└────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘
     │              │              │              │
     │ POST /login  │              │              │
     ├─────────────▶│              │              │
     │              │ Перенаправ.  │              │
     │              ├─────────────▶│              │
     │              │              │ Валидация    │
     │              │              ├─────────────▶│
     │              │              │              │
     │              │              │◀─────────────┤
     │              │              │ Генерация JWT│
     │              │◀─────────────┤              │
     │              │              │              │
     │◀─────────────┤              │              │
     │ JWT Токен    │              │              │
     │              │              │              │
```

### 2. **Поток Доступа к DICOM Исследованию**

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  OHIF   │    │  Nginx  │    │ Orthanc │    │База Дан.│
└────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘
     │              │              │              │
     │ GET /studies │              │              │
     ├─────────────▶│              │              │
     │              │ Проверка Auth│              │
     │              │ + Перенаправ.│              │
     │              ├─────────────▶│              │
     │              │              │ Запрос Мета  │
     │              │              ├─────────────▶│
     │              │              │              │
     │              │              │◀─────────────┤
     │              │              │ Возврат JSON │
     │              │◀─────────────┤              │
     │              │              │              │
     │◀─────────────┤              │              │
     │ Список Иссл. │              │              │
     │              │              │              │
```

### 3. **Поток Создания Отчета**

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ Врач    │    │  OHIF   │    │ Браузер │    │Хранилище│
│Интерфейс│    │Viewer   │    │LocalStor│    │ (PDF)   │
└────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘
     │              │              │              │
     │ Создать Отчет│              │              │
     ├─────────────▶│              │              │
     │              │ Получить Дан.│              │
     │              │ Пациента     │              │
     │              ├─────────────▶│              │
     │              │              │              │
     │              │◀─────────────┤              │
     │              │ Сохранить    │              │
     │              │ Отчет        │              │
     │              ├─────────────▶│              │
     │              │              │              │
     │ Экспорт PDF  │              │              │
     ├─────────────▶│              │              │
     │              │ Генерация PDF│              │
     │              ├─────────────────────────────▶│
     │              │              │              │
     │◀─────────────┴──────────────┴──────────────┤
     │                    PDF Скачивание          │
     │                                            │
```

---

## 🔒 Архитектура Безопасности

### Сетевая Безопасность
```
┌─────────────────────────────────────────────────────────┐
│                    СЛОИ БЕЗОПАСНОСТИ                    │
├─────────────────────────────────────────────────────────┤
│ Слой 1: Сеть        │ TLS 1.3 Шифрование               │
│                     │ Управление SSL Сертификатами     │
│                     │ Принуждение HTTPS (301 Редирект) │
├─────────────────────────────────────────────────────────┤
│ Слой 2: Прокси      │ Заголовки Безопасности (HSTS, CSP)│
│                     │ Ограничение Частоты              │
│                     │ Фильтрация Запросов              │
├─────────────────────────────────────────────────────────┤
│ Слой 3: Приложение  │ JWT Аутентификация               │
│                     │ Ролевой Контроль Доступа         │
│                     │ Управление Сессиями              │
├─────────────────────────────────────────────────────────┤
│ Слой 4: Данные      │ Шифрование Базы Данных          │
│                     │ Аудит Логирование               │
│                     │ Шифрование Бэкапов              │
└─────────────────────────────────────────────────────────┘
```

### Поток Аутентификации
```
┌─────────────────────────────────────────────────────────┐
│                 РЕАЛИЗАЦИЯ RBAC                         │
├─────────────────────────────────────────────────────────┤
│  Роль: ADMIN        │  Разрешения:                      │
│  ├─ Управление Польз.│  - Создание/Удаление Пользователей│
│  ├─ Конфигурация Сист.│  - Изменение Настроек Системы   │
│  ├─ Полный DICOM     │  - Все DICOM Операции           │
│  └─ Все Отчеты       │  - Создание/Редактирование/Удаление│
├─────────────────────────────────────────────────────────┤
│  Роль: DOCTOR       │  Разрешения:                      │
│  ├─ Данные Пациентов │  - Просмотр Информации Пациентов │
│  ├─ Доступ к Исслед. │  - Просмотр/Скачивание Исследований│
│  ├─ Система Отчетов  │  - Создание/Редактирование/Экспорт│
│  └─ Измерения        │  - Добавление Аннотаций и Измерений│
├─────────────────────────────────────────────────────────┤
│  Роль: OPERATOR     │  Разрешения:                      │
│  ├─ Загрузка Исслед. │  - Загрузка DICOM Файлов        │
│  ├─ Базовый Просмотр │  - Просмотр Исследований (Только Чтение)│
│  ├─ Инфо о Пациентах │  - Просмотр Данных Пациентов    │
│  └─ Ограниченный Дост.│  - Без Создания/Редактирования Отчетов│
└─────────────────────────────────────────────────────────┘
```

---

## 📊 Архитектура Производительности

### Стратегия Кэширования
```
┌─────────────────────────────────────────────────────────┐
│                   СЛОИ КЭШИРОВАНИЯ                      │
├─────────────────────────────────────────────────────────┤
│ Кэш Браузера       │ Статические Ресурсы (JS, CSS, Изображения)│
│ TTL: 1 час         │ OHIF Viewer Компоненты            │
├─────────────────────────────────────────────────────────┤
│ Кэш Приложения     │ Метаданные Исследований (5 мин TTL)│
│ Расположение: Память│ Информация о Пациентах           │
│                    │ Языковые Предпочтения            │
├─────────────────────────────────────────────────────────┤
│ Кэш Базы Данных    │ Кэширование Результатов Запросов │
│ PostgreSQL Буфер   │ Пулинг Соединений                │
│                    │ Оптимизация Индексов             │
├─────────────────────────────────────────────────────────┤
│ Nginx Кэш          │ Кэширование Ответов Прокси       │
│ Статические Файлы  │ Gzip Сжатие                      │
│                    │ Минификация Ресурсов             │
└─────────────────────────────────────────────────────────┘
```

### Распределение Нагрузки
```
┌─────────────────────────────────────────────────────────┐
│              СТРАТЕГИЯ БАЛАНСИРОВКИ НАГРУЗКИ            │
├─────────────────────────────────────────────────────────┤
│ Nginx Прокси       │ Round-Robin Распределение         │
│                    │ Мониторинг Проверки Здоровья     │
│                    │ Обработка Отказоустойчивости     │
├─────────────────────────────────────────────────────────┤
│ Масштабирование    │ Горизонтальное Масштабирование OHIF│
│ Сервисов           │ Пулинг Соединений Базы Данных    │
│                    │ Управление Экземплярами Orthanc  │
├─────────────────────────────────────────────────────────┤
│ Ограничения Ресурсов│ Лимиты Памяти Контейнеров       │
│                    │ Распределение CPU                │
│                    │ Оптимизация I/O Хранилища       │
└─────────────────────────────────────────────────────────┘
```

---

## 🔧 Архитектура Развертывания

### Оркестрация Контейнеров
```
┌─────────────────────────────────────────────────────────┐
│                DOCKER COMPOSE СТЕК                      │
├─────────────────────────────────────────────────────────┤
│ Сети:              │ Тома:                             │
│ ├─ default         │ ├─ orthanc_data (DICOM файлы)     │
│ ├─ backend         │ ├─ postgres_data (Файлы БД)       │
│ └─ frontend        │ ├─ flask_data (Пользовательская БД)│
│                    │ └─ nginx_logs (Логи доступа)      │
├─────────────────────────────────────────────────────────┤
│ Проверки Здоровья: │ Политики Перезапуска:            │
│ ├─ HTTP эндпоинты  │ ├─ unless-stopped                │
│ ├─ Соединение с БД │ ├─ on-failure (макс 3)           │
│ └─ Статус сервиса  │ └─ always (критические сервисы)  │
└─────────────────────────────────────────────────────────┘
```

### Конфигурация Окружения
```
┌─────────────────────────────────────────────────────────┐
│              УПРАВЛЕНИЕ ОКРУЖЕНИЕМ                      │
├─────────────────────────────────────────────────────────┤
│ Разработка:        │ Продакшн:                         │
│ ├─ SQLite БД       │ ├─ PostgreSQL БД                  │
│ ├─ Отладочное Лог. │ ├─ Только Логирование Ошибок     │
│ ├─ Авто-перезагр.  │ ├─ Оптимизированная Производит.   │
│ └─ Тестовые Данные │ └─ Усиленная Безопасность         │
├─────────────────────────────────────────────────────────┤
│ Конфигурация:      │ Управление Секретами:            │
│ ├─ Переменные Окруж.│ ├─ Docker Секреты               │
│ ├─ Файлы Конфигур. │ ├─ SSL Сертификаты              │
│ └─ Docker Compose  │ └─ Учетные Данные БД            │
└─────────────────────────────────────────────────────────┘
```

---

## 📈 Мониторинг и Логирование

### Системный Мониторинг
```
┌─────────────────────────────────────────────────────────┐
│                 СТЕК МОНИТОРИНГА                        │
├─────────────────────────────────────────────────────────┤
│ Здоровье Контейнеров:│ Метрики Приложений:              │
│ ├─ Docker Stats     │ ├─ Времена Ответов               │
│ ├─ Использование Пам.│ ├─ Уровни Ошибок                 │
│ ├─ Утилизация CPU   │ ├─ Пользовательские Сессии       │
│ └─ Диск I/O         │ └─ Скорости Передачи DICOM       │
├─────────────────────────────────────────────────────────┤
│ Агрегация Логов:   │ Алертинг:                         │
│ ├─ Централизованные │ ├─ Сбои Проверки Здоровья        │
│ ├─ Структурированные│ ├─ Высокие Уровни Ошибок         │
│ ├─ Поисковые        │ ├─ Истощение Ресурсов            │
│ └─ Политика Хранения│ └─ События Безопасности          │
└─────────────────────────────────────────────────────────┘
```

---

## 🔄 Точки Интеграции

### Интеграция с Внешними Системами
```
┌─────────────────────────────────────────────────────────┐
│               АРХИТЕКТУРА ИНТЕГРАЦИИ                    │
├─────────────────────────────────────────────────────────┤
│ DICOM Устройства:  │ HL7 Системы:                      │
│ ├─ Модальности     │ ├─ Интеграция HIS                 │
│ ├─ PACS Системы    │ ├─ Подключение EMR                │
│ ├─ Рабочие Станции │ ├─ Лабораторные Системы          │
│ └─ Мобильные Устр. │ └─ Биллинговые Системы           │
├─────────────────────────────────────────────────────────┤
│ API Эндпоинты:     │ Обмен Данными:                    │
│ ├─ RESTful API     │ ├─ DICOMweb Протокол              │
│ ├─ Аутентификация  │ ├─ HL7 FHIR (Будущее)            │
│ ├─ Управление Польз.│ ├─ Экспорт PDF                   │
│ └─ Система Отчетов  │ └─ Резервное копирование/Восстановление│
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 Атрибуты Качества

### Требования к Производительности
- **Время Ответа**: < 3с загрузка страницы, < 2с рендеринг изображения
- **Пропускная Способность**: 100+ одновременных пользователей, 1000+ исследований/день
- **Масштабируемость**: Горизонтальное масштабирование для экземпляров OHIF
- **Доступность**: Целевое время работы 99.9%

### Требования к Безопасности
- **Аутентификация**: Поддержка многофакторной аутентификации
- **Авторизация**: Детализированные ролевые разрешения
- **Шифрование**: Данные в покое и при передаче
- **Соответствие**: Соображения HIPAA/GDPR

### Требования к Надежности
- **Резервное копирование**: Ежедневные автоматические резервные копии с проверкой
- **Восстановление**: RTO ≤ 4 часа, RPO ≤ 1 час
- **Отказоустойчивость**: Изящная деградация при отказе компонентов
- **Мониторинг**: Мониторинг состояния в реальном времени и алертинг

---

**Версия Документа**: 1.0  
**Автор**: Tim Hunt (tr00x)  
**Последнее Обновление**: Декабрь 2024  
**Цикл Пересмотра**: Ежеквартально 